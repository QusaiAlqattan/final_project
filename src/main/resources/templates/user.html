<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Code Editor</title>
    <style>
        /* styles.css */
        body {
            font-family: Arial, sans-serif;
        }

        button {
            padding: 10px 20px;
            margin: 10px;
        }

        .modal {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 300px;
            position: relative;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 10px;
            text-align: left;
        }
    </style>
</head>
<body>
<h1>Collaborative Code Editor</h1>

<!-- Buttons for creating files, folders, and branches -->
<button id="createFileBtn">Create File</button>
<button id="createFolderBtn">Create Folder</button>
<button id="createBranchBtn">Create Branch</button>

<!-- Modal for creating a file -->
<div id="fileModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" id="closeFileModal">&times;</span>
        <h2>Create New File</h2>
        <label for="fileName">File Name:</label>
        <input type="text" id="fileName" required>
        <div>
            <label for="insideFolderFile">Should it be inside a folder?</label>
            <input type="checkbox" id="insideFolderFile">
        </div>
        <div id="folderSelectionFile" style="display: none;">
            <label for="folderSelectFile">Select a Folder:</label>
            <select id="folderSelectFile"></select>
        </div>
        <button id="submitFileBtn">Create File</button>
    </div>
</div>

<!-- Modal for creating a folder -->
<div id="folderModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" id="closeFolderModal">&times;</span>
        <h2>Create New Folder</h2>
        <label for="folderName">Folder Name:</label>
        <input type="text" id="folderName" required>
        <div>
            <label for="insideFolderFolder">Should it be inside a folder?</label>
            <input type="checkbox" id="insideFolderFolder">
        </div>
        <div id="folderSelectionFolder" style="display: none;">
            <label for="folderSelectFolder">Select a Folder:</label>
            <select id="folderSelectFolder"></select>
        </div>
        <button id="submitFolderBtn">Create Folder</button>
    </div>
</div>

<!-- Modal for creating a branch -->
<div id="branchModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" id="closeBranchModal">&times;</span>
        <h2>Create New Branch</h2>
        <label for="branchName">Branch Name:</label>
        <input type="text" id="branchName" required>
        <div>
            <label for="fromExistingBranch">Create from existing branch?</label>
            <input type="checkbox" id="fromExistingBranch">
        </div>
        <div id="existingBranchSelection" style="display: none;">
            <label for="branchSelect">Select an Existing Branch:</label>
            <select id="branchSelect"></select>
        </div>
        <button id="submitBranchBtn">Create Branch</button>
    </div>
</div>

<!-- Table for displaying folders -->
<h2>Folders</h2>
<table id="foldersTable">
    <thead>
    <tr>
        <th>Name</th>
        <th>Container</th>
        <th>Branch</th>
    </tr>
    </thead>
    <tbody>
    <!-- Dynamic rows for folders will be added here -->
    </tbody>
</table>

<!-- Table for displaying files -->
<h2>Files</h2>
<table id="filesTable">
    <thead>
    <tr>
        <th>Name</th>
        <th>Container</th>
        <th>Branch</th>
    </tr>
    </thead>
    <tbody>
    <!-- Dynamic rows for files will be added here -->
    </tbody>
</table>

<!-- Table for displaying branches -->
<h2>Branches</h2>
<table id="branchesTable">
    <thead>
    <tr>
        <th>Name</th>
    </tr>
    </thead>
    <tbody>
    <!-- Dynamic rows for branches will be added here -->
    </tbody>
</table>

<form action="/logout" method="post">
    <button type="submit">Logout</button>
</form>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const createFileBtn = document.getElementById("createFileBtn");
        const createFolderBtn = document.getElementById("createFolderBtn");
        const createBranchBtn = document.getElementById("createBranchBtn");

        const fileModal = document.getElementById("fileModal");
        const folderModal = document.getElementById("folderModal");
        const branchModal = document.getElementById("branchModal");

        const closeFileModal = document.getElementById("closeFileModal");
        const closeFolderModal = document.getElementById("closeFolderModal");
        const closeBranchModal = document.getElementById("closeBranchModal");

        const fileName = document.getElementById("fileName");
        const insideFolderFileCheckbox = document.getElementById("insideFolderFile");
        const folderSelectionFile = document.getElementById("folderSelectionFile");
        const folderSelectFile = document.getElementById("folderSelectFile");
        const submitFileBtn = document.getElementById("submitFileBtn");

        const folderName = document.getElementById("folderName");
        const insideFolderFolderCheckbox = document.getElementById("insideFolderFolder");
        const folderSelectionFolder = document.getElementById("folderSelectionFolder");
        const folderSelectFolder = document.getElementById("folderSelectFolder");
        const submitFolderBtn = document.getElementById("submitFolderBtn");

        const branchName = document.getElementById("branchName");
        const fromExistingBranchCheckbox = document.getElementById("fromExistingBranch");
        const existingBranchSelection = document.getElementById("existingBranchSelection");
        const branchSelect = document.getElementById("branchSelect");
        const submitBranchBtn = document.getElementById("submitBranchBtn");

        const foldersTable = document.getElementById("foldersTable").querySelector("tbody");
        const filesTable = document.getElementById("filesTable").querySelector("tbody");
        const branchesTable = document.getElementById("branchesTable").querySelector("tbody");

        // Fetch folders, files, and branches when the page loads
        fetchFoldersAndFiles();
        fetchBranches();

        createFileBtn.addEventListener("click", function () {
            openFileModal();
        });

        createFolderBtn.addEventListener("click", function () {
            openFolderModal();
        });

        createBranchBtn.addEventListener("click", function () {
            openBranchModal();
        });

        closeFileModal.addEventListener("click", closeFileModalFunction);
        closeFolderModal.addEventListener("click", closeFolderModalFunction);
        closeBranchModal.addEventListener("click", closeBranchModalFunction);

        insideFolderFileCheckbox.addEventListener("change", function () {
            folderSelectionFile.style.display = insideFolderFileCheckbox.checked ? "block" : "none";
            if (insideFolderFileCheckbox.checked) {
                fetchFoldersForFile();
            }
        });

        insideFolderFolderCheckbox.addEventListener("change", function () {
            folderSelectionFolder.style.display = insideFolderFolderCheckbox.checked ? "block" : "none";
            if (insideFolderFolderCheckbox.checked) {
                fetchFoldersForFolder();
            }
        });

        fromExistingBranchCheckbox.addEventListener("change", function () {
            existingBranchSelection.style.display = fromExistingBranchCheckbox.checked ? "block" : "none";
            if (fromExistingBranchCheckbox.checked) {
                fetchBranches(); // Load existing branches for selection
            }
        });

        submitFileBtn.addEventListener("click", submitFile);
        submitFolderBtn.addEventListener("click", submitFolder);
        submitBranchBtn.addEventListener("click", submitBranch);

        function openFileModal() {
            fileModal.style.display = "flex";
            fileName.value = ""; // Reset input
            insideFolderFileCheckbox.checked = false;
            folderSelectionFile.style.display = "none";
        }

        function closeFileModalFunction() {
            fileModal.style.display = "none";
        }

        function openFolderModal() {
            folderModal.style.display = "flex";
            folderName.value = ""; // Reset input
            insideFolderFolderCheckbox.checked = false;
            folderSelectionFolder.style.display = "none";
        }

        function closeFolderModalFunction() {
            folderModal.style.display = "none";
        }

        function openBranchModal() {
            branchModal.style.display = "flex";
            branchName.value = ""; // Reset input
            fromExistingBranchCheckbox.checked = false;
            existingBranchSelection.style.display = "none";
        }

        function closeBranchModalFunction() {
            branchModal.style.display = "none";
        }

        async function fetchFoldersAndFiles() {
            try {
                // Fetch both folders and files
                const folderResponse = await fetch('/api/folders');
                const folders = await folderResponse.json();

                const fileResponse = await fetch('/api/files');
                const files = await fileResponse.json();

                populateFoldersTable(folders);
                populateFilesTable(files);
            } catch (error) {
                console.error('Error fetching folders and files:', error);
            }
        }

        function populateFoldersTable(folders) {
            foldersTable.innerHTML = ""; // Clear table

            // Add folders to the table
            folders.forEach(folder => {
                const row = document.createElement("tr");

                const nameCell = document.createElement("td");
                nameCell.textContent = folder.name;

                const containerCell = document.createElement("td");
                containerCell.textContent = folder.containerName ? folder.containerName : "Root";

                const branchCell = document.createElement("td");
                branchCell.textContent = folder.branch ? folder.branch.name : "N/A";

                row.appendChild(nameCell);
                row.appendChild(containerCell);
                row.appendChild(branchCell);

                foldersTable.appendChild(row);
            });
        }

        function populateFilesTable(files) {
            filesTable.innerHTML = ""; // Clear table

            // Add files to the table
            files.forEach(file => {
                const row = document.createElement("tr");

                const nameCell = document.createElement("td");
                nameCell.textContent = file.name;

                const containerCell = document.createElement("td");
                containerCell.textContent = file.containerName ? file.containerName : "Root";

                const branchCell = document.createElement("td");
                branchCell.textContent = file.branch ? file.branch.name : "N/A";

                row.appendChild(nameCell);
                row.appendChild(containerCell);
                row.appendChild(branchCell);

                filesTable.appendChild(row);
            });
        }

        async function fetchBranches() {
            try {
                const response = await fetch('/api/branches');
                const branches = await response.json();
                populateBranchesTable(branches);
                populateBranchSelect(branches);
            } catch (error) {
                console.error('Error fetching branches:', error);
            }
        }

        function populateBranchesTable(branches) {
            branchesTable.innerHTML = ""; // Clear table
            branches.forEach(branch => {
                const row = document.createElement("tr");
                const nameCell = document.createElement("td");
                nameCell.textContent = branch.name;
                row.appendChild(nameCell);
                branchesTable.appendChild(row);
            });
        }

        async function fetchFoldersForFile() {
            try {
                const response = await fetch('/api/folders');
                const folders = await response.json();
                populateFolderSelectFile(folders);
            } catch (error) {
                console.error('Error fetching folders:', error);
            }
        }

        function populateFolderSelectFile(folders) {
            folderSelectFile.innerHTML = "";
            folders.forEach(folder => {
                const option = document.createElement("option");
                option.value = folder.uniqueId; // Assuming uniqueId is the identifier
                option.textContent = folder.name;
                folderSelectFile.appendChild(option);
            });
        }

        async function fetchFoldersForFolder() {
            try {
                const response = await fetch('/api/folders');
                const folders = await response.json();
                populateFolderSelectFolder(folders);
            } catch (error) {
                console.error('Error fetching folders:', error);
            }
        }

        function populateFolderSelectFolder(folders) {
            folderSelectFolder.innerHTML = "";
            folders.forEach(folder => {
                const option = document.createElement("option");
                option.value = folder.uniqueId; // Assuming uniqueId is the identifier
                option.textContent = folder.name;
                folderSelectFolder.appendChild(option);
            });
        }

        async function populateBranchSelect(branches) {
            branchSelect.innerHTML = "";
            branches.forEach(branch => {
                const option = document.createElement("option");
                option.value = branch.uniqueId; // Assuming uniqueId is the identifier
                option.textContent = branch.name;
                branchSelect.appendChild(option);
            });
        }

        async function submitFile() {
            const name = fileName.value;
            const folderId = insideFolderFileCheckbox.checked ? folderSelectFile.value : null;
            const data = {
                name: name,
                container: folderId ? { uniqueId: folderId } : null,
            };

            try {
                const response = await fetch(`/api/files`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                if (response.ok) {
                    alert('File created successfully!');
                    fetchFoldersAndFiles(); // Refresh the folder and file list
                    closeFileModalFunction();
                } else {
                    alert('Error creating the file.', response);
                }
            } catch (error) {
                console.error('Error submitting the file:', error);
            }
        }

        async function submitFolder() {
            const name = folderName.value;
            const folderId = insideFolderFolderCheckbox.checked ? folderSelectFolder.value : null;
            const data = {
                name: name,
                container: folderId ? { uniqueId: folderId } : null,
            };

            try {
                const response = await fetch(`/api/folders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                if (response.ok) {
                    alert('Folder created successfully!');
                    fetchFoldersAndFiles(); // Refresh the folder and file list
                    closeFolderModalFunction();
                } else {
                    alert('Error creating the folder.', response);
                }
            } catch (error) {
                console.error('Error submitting the folder:', error);
            }
        }

        async function submitBranch() {
            const name = branchName.value;
            const parentBranchId = fromExistingBranchCheckbox.checked ? branchSelect.value : null;
            const data = {
                name: name,
                parentBranch: parentBranchId ? { uniqueId: parentBranchId } : null,
            };

            try {
                const response = await fetch(`/api/branches`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                if (response.ok) {
                    alert('Branch created successfully!');
                    fetchBranches(); // Refresh the branches list
                    closeBranchModalFunction();
                } else {
                    alert('Error creating the branch.', response);
                }
            } catch (error) {
                console.error('Error submitting the branch:', error);
            }
        }
    });
</script>
</body>
</html>
